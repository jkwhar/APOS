{% extends "base.html" %}
{% block title %}Bulk Add Parts — APOS Inventory{% endblock %}

{% block content %}

<h2 class="mb-4">Bulk Add Parts (5 Rows)</h2>
<div class="mb-3">
  <a href="/add" class="btn btn-outline-secondary btn-sm">➕ Switch to Single Add</a>
</div>

<div class="card shadow-sm">
    <div class="card-body">

        <form action="/add/bulk" method="post" class="row g-3">

            <!-- Global Controls -->
            <div class="row g-3 align-items-end mb-2">
                <div class="col-md-6">
                    <label class="form-label fw-bold mb-1">Global Category</label>
                    <div class="input-group input-group-sm">
                        <select id="global_category" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.name }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="applyCategoryToAll()">Apply</button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold mb-1">Global Store</label>
                    <div class="input-group input-group-sm">
                        <select id="global_store" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            {% for s in stores %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="applyStoreToAll()">Apply</button>
                    </div>
                </div>
            </div>

            <div class="alert alert-secondary p-3 mb-3">
             <label class="form-label fw-bold">Bulk Paste Part Numbers</label>
             <textarea id="bulk_paste_box" class="form-control mb-2" rows="4" placeholder="Paste part numbers here, one per line"></textarea>
             <button type="button" class="btn btn-outline-dark btn-sm" onclick="bulkPasteFill()">Fill Table</button>
            </div>

            <!-- Table -->
            <div class="col-12 table-responsive">
                <table class="table table-bordered table-striped align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Part Number</th>
                            <th>Category</th>
                            <th>Store</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Barcode</th>
                            <th>Bin Code</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% for r in rows %}
                        <tr>
                            <td>
                                <input type="text" name="part_number"
                                       class="form-control"
                                       onblur="autoFillFromPartNumber(this)">
                            </td>

                            <td>
                                <select name="category" class="form-select row_category">
                                    <option value="">-- None --</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.name }}">{{ cat.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <select name="store" class="form-select row_store">
                                    <option value="">-- None --</option>
                                    {% for s in stores %}
                                    <option value="{{ s.name }}">{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <input type="text" name="description" class="form-control">
                            </td>

                            <td>
                                <input type="number" step="0.01" name="price" class="form-control">
                            </td>

                            <td>
                                <input type="number" name="quantity" value="1" class="form-control">
                            </td>

                            <td>
                                <input type="text" name="barcode" class="form-control">
                            </td>

                            <td>
                                <input type="text" name="bin_code" class="form-control">
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                    <tr id="add_row_anchor"></tr>
                </table>
            </div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary btn-lg">Add All Parts</button>
            </div>

        </form>

    </div>
</div>

<script>
function applyCategoryToAll() {
    const value = document.getElementById('global_category').value;
    document.querySelectorAll('.row_category').forEach(x => x.value = value);
}
function applyStoreToAll() {
    const value = document.getElementById('global_store').value;
    document.querySelectorAll('.row_store').forEach(x => x.value = value);
}
</script>

<script>
function bulkPasteFill(){
    const lines = document
        .getElementById('bulk_paste_box')
        .value
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(Boolean);

    if (!lines.length) return;

    const tbody = document.querySelector('table tbody');
    const template = tbody.querySelector('tr');

    if (!template) return;

    // Ensure we have enough rows to populate all pasted lines
    while (document.querySelectorAll("input[name='part_number']").length < lines.length) {
        addRow(template, tbody);
    }

    const rows = document.querySelectorAll("input[name='part_number']");

    lines.forEach((line, idx) => {
        const input = rows[idx];
        if (!input) return;
        input.value = line;
        autoFillFromPartNumber(input);
        input.dispatchEvent(new Event("input"));
    });
}
function addRow(template, tbody){
    const body = tbody || document.querySelector('table tbody');
    const baseTemplate = template || body?.querySelector('tr');

    if (!body || !baseTemplate) return;

    const rowClone = baseTemplate.cloneNode(true);
    rowClone.querySelectorAll('input,select').forEach(el => {
        if (el.name === 'quantity') {
            el.value = '1';
        } else {
            el.value = '';
        }
    });
    body.appendChild(rowClone);
    return rowClone;
}
</script>

<script src="/static/autofill.js"></script>

{% endblock %}